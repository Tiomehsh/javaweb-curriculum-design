# Java Web项目部署指南

## 项目概述
- **项目类型**: Jakarta EE Web应用 (Java 23)
- **打包方式**: WAR包
- **数据库**: OpenGauss (PostgreSQL兼容)
- **应用服务器**: Tomcat 10.1+ (支持Jakarta EE)

## 一、服务器环境准备

### 1.1 Java环境
```bash
# 安装Java 23 (或Java 21 LTS)
sudo apt update
sudo apt install openjdk-23-jdk

# 验证安装
java -version
javac -version

# 设置JAVA_HOME
echo 'export JAVA_HOME=/usr/lib/jvm/java-23-openjdk-amd64' >> ~/.bashrc
echo 'export PATH=$PATH:$JAVA_HOME/bin' >> ~/.bashrc
source ~/.bashrc
```

### 1.2 Maven安装
```bash
# 安装Maven
sudo apt install maven

# 验证安装
mvn -version
```

### 1.3 Tomcat 10.1安装
```bash
# 创建tomcat用户
sudo useradd -r -m -U -d /opt/tomcat -s /bin/false tomcat

# 下载Tomcat 10.1
cd /tmp
wget https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.20/bin/apache-tomcat-10.1.20.tar.gz

# 解压到/opt/tomcat
sudo tar xf apache-tomcat-10.1.20.tar.gz -C /opt/tomcat --strip-components=1

# 设置权限
sudo chown -R tomcat: /opt/tomcat
sudo sh -c 'chmod +x /opt/tomcat/bin/*.sh'
```

### 1.4 创建Tomcat系统服务
```bash
sudo nano /etc/systemd/system/tomcat.service
```

添加以下内容：
```ini
[Unit]
Description=Apache Tomcat Web Application Container
After=network.target

[Service]
Type=forking

Environment=JAVA_HOME=/usr/lib/jvm/java-23-openjdk-amd64
Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid
Environment=CATALINA_HOME=/opt/tomcat
Environment=CATALINA_BASE=/opt/tomcat
Environment='CATALINA_OPTS=-Xms512M -Xmx2048M -server -XX:+UseParallelGC'
Environment='JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom'

ExecStart=/opt/tomcat/bin/startup.sh
ExecStop=/opt/tomcat/bin/shutdown.sh

User=tomcat
Group=tomcat
UMask=0007
RestartSec=10
Restart=always

[Install]
WantedBy=multi-user.target
```

启动Tomcat服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable tomcat
sudo systemctl start tomcat
sudo systemctl status tomcat
```

## 二、项目打包部署

### 2.1 本地打包
在项目根目录执行：
```bash
# 清理并打包
mvn clean package

# 打包完成后，war文件位于 target/javaweb-curriculum-design-1.0-SNAPSHOT.war
```

### 2.2 上传到服务器
```bash
# 使用scp上传war包到服务器
scp target/javaweb-curriculum-design-1.0-SNAPSHOT.war username@your-server:/tmp/

# 或者使用rsync
rsync -av target/javaweb-curriculum-design-1.0-SNAPSHOT.war username@your-server:/tmp/
```

### 2.3 部署到Tomcat
```bash
# 停止Tomcat
sudo systemctl stop tomcat

# 清理旧部署
sudo rm -rf /opt/tomcat/webapps/javaweb-curriculum-design*

# 复制新的war包
sudo cp /tmp/javaweb-curriculum-design-1.0-SNAPSHOT.war /opt/tomcat/webapps/

# 重命名为ROOT.war (如果要部署为根应用)
# sudo mv /opt/tomcat/webapps/javaweb-curriculum-design-1.0-SNAPSHOT.war /opt/tomcat/webapps/ROOT.war
# 或者保持原名，通过上下文路径访问

# 设置权限
sudo chown tomcat:tomcat /opt/tomcat/webapps/*.war

# 启动Tomcat
sudo systemctl start tomcat
```

## 三、Caddy反向代理配置

### 3.1 安装Caddy
```bash
# 安装Caddy
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

### 3.2 配置Caddy
```bash
sudo nano /etc/caddy/Caddyfile
```

添加以下配置：
```caddyfile
# 替换your-domain.com为你的实际域名
your-domain.com {
    # 自动HTTPS
    tls {
        # 使用Let's Encrypt自动获取SSL证书
    }
    
    # 反向代理到Tomcat
    reverse_proxy localhost:8080
    
    # 启用压缩
    encode gzip
    
    # 静态文件缓存
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static Cache-Control "public, max-age=31536000"
    
    # 日志
    log {
        output file /var/log/caddy/access.log
        format json
    }
    
    # 错误页面
    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        rewrite @404 /error/404.jsp
        reverse_proxy localhost:8080
    }
}

# 可选：重定向www子域名
www.your-domain.com {
    redir https://your-domain.com{uri} permanent
}
```

### 3.3 启动Caddy
```bash
# 测试配置
sudo caddy validate --config /etc/caddy/Caddyfile

# 启动Caddy服务
sudo systemctl enable caddy
sudo systemctl start caddy
sudo systemctl status caddy
```

## 四、数据库配置

### 4.1 生产环境数据库配置
创建生产环境配置文件：
```bash
sudo nano /opt/tomcat/conf/database.properties
```

内容：
```properties
# 生产环境数据库配置
jdbc.driver=org.postgresql.Driver
jdbc.url=jdbc:postgresql://your-db-server:5432/JAVA_WEB
jdbc.username=your-db-username
jdbc.password=your-secure-password

# 连接池配置（生产环境优化）
hikari.poolName=CampusPassPool-Prod
hikari.minimumIdle=10
hikari.maximumPoolSize=50
hikari.connectionTimeout=30000
hikari.idleTimeout=600000
hikari.maxLifetime=1800000
hikari.connectionTestQuery=SELECT 1
```

### 4.2 修改应用读取配置路径
在Tomcat启动参数中添加系统属性：
```bash
sudo nano /etc/systemd/system/tomcat.service
```

在JAVA_OPTS中添加：
```bash
Environment='JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom -Dconfig.path=/opt/tomcat/conf/'
```

## 五、安全配置

### 5.1 防火墙设置
```bash
# 启用ufw防火墙
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 不直接暴露Tomcat端口8080到外网
# sudo ufw deny 8080

# 查看状态
sudo ufw status
```

### 5.2 Tomcat安全配置
编辑Tomcat配置：
```bash
sudo nano /opt/tomcat/conf/server.xml
```

关键安全配置：
```xml
<!-- 隐藏版本信息 -->
<Connector port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           redirectPort="8443"
           server="Apache" />

<!-- 禁用不必要的HTTP方法 -->
<security-constraint>
    <web-resource-collection>
        <web-resource-name>restricted methods</web-resource-name>
        <url-pattern>/*</url-pattern>
        <http-method>PUT</http-method>
        <http-method>DELETE</http-method>
        <http-method>HEAD</http-method>
        <http-method>OPTIONS</http-method>
        <http-method>TRACE</http-method>
    </web-resource-collection>
    <auth-constraint />
</security-constraint>
```

## 六、监控和日志

### 6.1 日志配置
```bash
# 创建日志目录
sudo mkdir -p /var/log/javaweb-app
sudo chown tomcat:tomcat /var/log/javaweb-app

# 配置日志轮转
sudo nano /etc/logrotate.d/tomcat
```

添加内容：
```
/opt/tomcat/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    notifempty
    create 640 tomcat tomcat
}
```

### 6.2 健康检查脚本
```bash
sudo nano /opt/scripts/health-check.sh
```

```bash
#!/bin/bash
# 健康检查脚本

APP_URL="http://localhost:8080/javaweb-curriculum-design-1.0-SNAPSHOT/"
HEALTH_CHECK_URL="${APP_URL}public/"

# 检查应用是否响应
if curl -f -s "$HEALTH_CHECK_URL" > /dev/null; then
    echo "$(date): Application is healthy"
    exit 0
else
    echo "$(date): Application is not responding"
    # 重启Tomcat
    systemctl restart tomcat
    exit 1
fi
```

```bash
sudo chmod +x /opt/scripts/health-check.sh

# 添加到crontab，每5分钟检查一次
echo "*/5 * * * * /opt/scripts/health-check.sh >> /var/log/health-check.log 2>&1" | sudo crontab -
```

## 七、部署脚本自动化

### 7.1 自动部署脚本
```bash
sudo nano /opt/scripts/deploy.sh
```

```bash
#!/bin/bash
# 自动部署脚本

set -e

APP_NAME="javaweb-curriculum-design"
WAR_FILE="$1"
TOMCAT_HOME="/opt/tomcat"
BACKUP_DIR="/opt/backups"

if [ -z "$WAR_FILE" ]; then
    echo "Usage: $0 <war-file-path>"
    exit 1
fi

# 创建备份
echo "Creating backup..."
mkdir -p "$BACKUP_DIR"
if [ -f "$TOMCAT_HOME/webapps/${APP_NAME}.war" ]; then
    cp "$TOMCAT_HOME/webapps/${APP_NAME}.war" "$BACKUP_DIR/${APP_NAME}-$(date +%Y%m%d-%H%M%S).war"
fi

# 停止Tomcat
echo "Stopping Tomcat..."
systemctl stop tomcat

# 清理旧部署
echo "Cleaning old deployment..."
rm -rf "$TOMCAT_HOME/webapps/${APP_NAME}"*

# 部署新版本
echo "Deploying new version..."
cp "$WAR_FILE" "$TOMCAT_HOME/webapps/${APP_NAME}.war"
chown tomcat:tomcat "$TOMCAT_HOME/webapps/${APP_NAME}.war"

# 启动Tomcat
echo "Starting Tomcat..."
systemctl start tomcat

# 等待应用启动
echo "Waiting for application to start..."
sleep 30

# 健康检查
if /opt/scripts/health-check.sh; then
    echo "Deployment successful!"
else
    echo "Deployment failed, check logs"
    exit 1
fi
```

```bash
sudo chmod +x /opt/scripts/deploy.sh
```

## 八、使用说明

### 8.1 访问应用
- **首页**: https://your-domain.com/ (自动跳转到public/index.jsp)
- **公网访问**: https://your-domain.com/javaweb-curriculum-design-1.0-SNAPSHOT/
- **管理后台**: https://your-domain.com/javaweb-curriculum-design-1.0-SNAPSHOT/admin/login.jsp
- **公共接待**: https://your-domain.com/javaweb-curriculum-design-1.0-SNAPSHOT/public/

**注意**: 如果部署为ROOT应用，访问路径为：
- **首页**: https://your-domain.com/ 
- **管理后台**: https://your-domain.com/admin/login.jsp
- **公共接待**: https://your-domain.com/public/

### 8.2 部署新版本
```bash
# 使用自动部署脚本
sudo /opt/scripts/deploy.sh /path/to/new/app.war
```

### 8.3 查看日志
```bash
# Tomcat日志
sudo tail -f /opt/tomcat/logs/catalina.out

# Caddy日志
sudo tail -f /var/log/caddy/access.log

# 应用日志
sudo tail -f /var/log/javaweb-app/app.log
```

## 九、故障排除

### 9.1 常见问题
1. **应用无法启动**: 检查Java版本和Tomcat兼容性
2. **数据库连接失败**: 检查数据库配置和网络连通性
3. **SSL证书问题**: 检查域名DNS设置和Caddy配置
4. **内存不足**: 调整Tomcat JVM参数

### 9.2 性能优化
- 调整JVM堆内存大小
- 优化数据库连接池配置
- 启用Gzip压缩
- 配置静态资源缓存

## 十、备份和恢复
定期备份：
- 应用WAR包
- 数据库数据
- 配置文件

确保有完整的灾难恢复计划。
