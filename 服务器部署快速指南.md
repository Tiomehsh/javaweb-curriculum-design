# 服务器Docker部署快速指南

## 一、服务器环境准备

### 1.1 安装Docker和Docker Compose
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动Docker服务
sudo systemctl enable docker
sudo systemctl start docker

# 将当前用户加入docker组
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 1.2 安装Git
```bash
sudo apt install git -y
```

## 二、克隆和配置项目

### 2.1 克隆项目
```bash
# 克隆项目到服务器
git clone https://github.com/Tiomehsh/javaweb-curriculum-design.git
cd javaweb-curriculum-design
```

### 2.2 配置数据库连接
```bash
# 复制环境变量配置文件
cp .env.example .env

# 编辑数据库配置
nano .env
```

在`.env`文件中配置您的数据库信息：
```env
# 数据库配置 - 填入您的实际配置
DB_HOST=your-database-server-ip
DB_PORT=5432
DB_NAME=JAVA_WEB
DB_USER=your-username
DB_PASSWORD=your-password

# Java JVM配置
JAVA_OPTS=-Xms512m -Xmx2048m

# 可选：如果使用自定义域名
DOMAIN=your-domain.com
```

**注意**: 应用会优先使用环境变量配置，如果环境变量未设置才会回退到properties文件。

在`.env`文件中配置您的数据库信息：
```env
# 数据库配置 - 填入您的实际配置
DB_HOST=your-database-server-ip
DB_PORT=5432
DB_NAME=JAVA_WEB
DB_USER=your-username
DB_PASSWORD=your-password

# Java JVM配置
JAVA_OPTS=-Xms512m -Xmx2048m

# 可选：如果使用自定义域名
DOMAIN=your-domain.com
```

### 2.3 配置域名（可选）
如果您有域名，只需在`.env`文件中配置即可，无需修改Caddyfile：
```env
DOMAIN=your-actual-domain.com
```

Caddy会自动使用环境变量中的域名并申请SSL证书。

## 三、部署应用

### 3.1 编译和启动
```bash
# 首先编译项目生成WAR文件
mvn clean package -DskipTests

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

### 3.2 检查启动日志
```bash
# 查看应用启动日志
docker-compose logs -f app

# 如果需要查看所有服务日志
docker-compose logs -f
```

### 3.3 健康检查
等待应用启动（通常需要1-2分钟），然后检查：
```bash
# 检查应用是否响应
curl -I http://localhost:8080/public/

# 或者如果配置了域名
curl -I https://your-domain.com/public/
```

## 四、访问应用

### 4.1 本地访问（仅IP）
- **首页**: http://your-server-ip:8080/
- **公共页面**: http://your-server-ip:8080/public/
- **管理后台**: http://your-server-ip:8080/admin/login.jsp

### 4.2 域名访问（如果配置了Caddy）
- **首页**: https://your-domain.com/
- **公共页面**: https://your-domain.com/public/
- **管理后台**: https://your-domain.com/admin/login.jsp

**注意**: 应用被部署为ROOT应用，因此访问路径中没有应用名称前缀。

## 五、常用管理命令

### 5.1 服务管理
```bash
# 停止所有服务
docker-compose down

# 重启应用服务
docker-compose restart app

# 重新构建并启动
docker-compose up -d --build

# 查看资源使用情况
docker stats
```

### 5.2 日志查看
```bash
# 查看实时日志
docker-compose logs -f app

# 查看最近100行日志
docker-compose logs --tail=100 app

# 查看Caddy日志
docker-compose logs caddy
```

### 5.3 应用更新
```bash
# 拉取最新代码
git pull origin main

# 重新编译和部署
mvn clean package -DskipTests
docker-compose down
docker-compose up -d
```

## 六、故障排除

### 6.1 常见问题

**应用无法启动**
```bash
# 检查Java进程
docker-compose exec app ps aux | grep java

# 检查端口占用
netstat -tlnp | grep 8080

# 查看详细错误
docker-compose logs app
```

**数据库连接失败**
```bash
# 从容器内测试数据库连接
docker-compose exec app ping $DB_HOST

# 检查环境变量
docker-compose exec app env | grep DB_
```

**Caddy证书问题**
```bash
# 查看Caddy日志
docker-compose logs caddy

# 检查DNS解析
nslookup your-domain.com

# 手动重新加载配置
docker-compose exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### 6.2 性能监控
```bash
# 查看容器资源使用
docker stats --no-stream

# 查看磁盘使用
df -h
docker system df

# 清理无用镜像和容器
docker system prune -a
```

## 七、安全建议

### 7.1 防火墙配置
```bash
# 启用防火墙
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 如果需要直接访问应用端口
sudo ufw allow 8080

# 查看防火墙状态
sudo ufw status
```

### 7.2 定期维护
```bash
# 定期更新系统
sudo apt update && sudo apt upgrade -y

# 定期清理Docker
docker system prune -f

# 备份重要配置
cp .env .env.backup
cp Caddyfile Caddyfile.backup
```

## 八、完成部署

按照以上步骤，您就可以在服务器上成功部署Java Web应用了！

### 8.1 部署检查清单
- ✅ Docker和Docker Compose已安装
- ✅ 项目已克隆到服务器
- ✅ .env文件已正确配置
- ✅ 数据库连接正常
- ✅ 应用容器启动成功
- ✅ Caddy代理配置正确（如果使用域名）

### 8.2 后续维护
定期执行以下维护操作：
- 更新应用代码：`git pull && mvn clean package -DskipTests && docker-compose up -d`
- 查看运行状态：`docker-compose ps`
- 清理无用资源：`docker system prune -f`
- 备份配置文件：`cp .env .env.backup`

现在您的Java Web应用已经在服务器上使用Docker成功运行了！